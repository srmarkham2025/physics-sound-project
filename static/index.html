<!DOCTYPE html>

<html lang = "en">
    <head>
        <meta charset="UTF-8">
        <title>Instrument Overtones & Air Pressure Series</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjs@15.0.0/lib/browser/math.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
        <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; color: #333; }
            h1, h2 { color: #2c3e50; }
            button { margin: 10px 5px; padding: 10px 15px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
            button:hover { background-color: #2980b9; }
            img { border: 1px solid #ccc; margin: 10px 0; }
            .instrument-section { margin-bottom: 40px; }    
        </style>
    </head>
    <body>
        <h1>Comparing Overtones of Various Instruments with Air Pressure Series </h1>
        <h2>The Spectrogram</h2>
        <audio id="audioPlayer" controls>
             <source src="fullScore.ogg" type="audio/ogg">
            Your browser does not support the audio element.
        </audio>
        <br>
        <br>
        <div class="flute" style = "position: relative; display: inline-block">
            <img id = "fluteSpectrogram"></img>
            <canvas id="fluteCanvas" style="position: absolute; top: 0; left: 0; z-index: 2;"></canvas>
        </div>
        <div class="clarinet" style = "position: relative; display: inline-block">
            <img id = "clarinetSpectrogram"></img>
            <canvas id="clarinetCanvas" style="position: absolute; top: 0; left: 0; z-index: 2;"></canvas>
        </div>  
        <div class="piano" style = "position: relative; display: inline-block">
            <img id = "pianoSpectrogram"></img>
            <canvas id="pianoCanvas" style="position: absolute; top: 0; left: 0; z-index: 2;"></canvas>
        </div>
        <div class="violin" style = "position: relative; display: inline-block">
            <img id="violinSpectrogram"></img>
            <canvas id="violinCanvas" style="position: absolute; top: 0; left: 0; z-index: 2;"></canvas>
        </div>
       
        <h2>Generating Series Approximations</h2>
        <button onClick = "generateSeries()" >Calculate p(t)</button>
        <button onClick = "generateDeviation()" >Calculate Deviation</button>
        <br>
    
        <div id = "pianoSeries"></div>
        <h2>Violin</h2>
        <div id = "violinSeries"></div>
        <h2>Flute</h2>
        <div id = "fluteSeries"></div>
        <h2>Clarinet</h2>
        <div id = "clarinetSeries"></div>



        <img id = "violinSeriesPlot"></img>
        <img id = "fluteSeriesPlot"></img>
        <img id = "clarinetSeriesPlot"></img>

        <img id = "violinDeviationPlot"></img>
        <img id = "fluteDeviationPlot"></img>
        <img id = "clarinetDeviationPlot"></img>
        <img id = "pianoDeviationPlot"></img>

        <script>
            const instruments = ["piano", "violin", "flute", "clarinet"]
            const audio = document.getElementById("audioPlayer")
            const playHeads = {}
            const specs = {}
            const playHeadCxts = {}
            for (let i = 0; i < 4; i++) {
                const instrument = instruments[i];
                const playHead = document.getElementById(instrument + "Canvas");
                const spec = document.getElementById(instrument + "Spectrogram");
                const playHeadCxt= playHead.getContext("2d");
                playHeads[instrument] = playHead;
                specs[instrument] = spec;
                playHeadCxts[instrument] = playHeadCxt;
            }
            audio.addEventListener("play", () => requestAnimationFrame(drawPlayhead));

            
              document.addEventListener('DOMContentLoaded', async () => {

                const response = await axios.get('/spectrogram');
                const source = response.data
                console.log(response.data)
                document.getElementById('violinSpectrogram').src = source.violin;
                document.getElementById('pianoSpectrogram').src = source.piano;
                document.getElementById('clarinetSpectrogram').src = source.clarinet;
                document.getElementById('fluteSpectrogram').src = source.flute;


            });
            
            function drawPlayhead() {
                for (let i = 1; i < instruments.length; i++) {
                    const instrument = instruments[i];
                    const playHead = playHeads[instrument];
                    const spec = specs[instrument];
                    const playHeadCxt = playHeadCxts[instrument];
                    playHead.height = spec.height;
                    playHead.width=spec.width;
                    playHeadCxt.clearRect(0, 0, playHead.width, playHead.height);

                    const x = (audio.currentTime / audio.duration) * 400 + 80;
                    playHeadCxt.strokeStyle = "cyan";
                    playHeadCxt.lineWidth = 2;
                    playHeadCxt.beginPath();
                    playHeadCxt.moveTo(x, 60);
                    playHeadCxt.lineTo(x, 430);
                    playHeadCxt.stroke();

                }
                requestAnimationFrame(drawPlayhead);

            }

            audio.addEventListener("play", () => requestAnimationFrame(drawPlayhead));


        async function generateSeries() {
            time = audio.currentTime;
            const response = await axios.get(`/series?time=${time}`);


            document.getElementById('violinSeries').innerHTML = "";
            document.getElementById('fluteSeries').innerHTML = "";
            document.getElementById('clarinetSeries').innerHTML = "";
            
            for (let i = 1; i < instruments.length; i++) {
                const instrument = instruments[i];
                console.log(instrument)
                console.log(response.data[instrument])
                console.log(response.data)
                const equation = response.data[instrument].equation;
                console.log(equation)
                const plotFile = response.data[instrument].file;
                const series = math.parse(equation)
                const seriesPath = instrument + "Series";
                const plotPath = seriesPath + "Plot"
                katex.render(
                    series.toTex({ parenthesis: 'auto', implicit: 'hide' }),
                    document.getElementById(seriesPath),
                    { throwOnError: false }
                );
                document.getElementById(plotPath).src = plotFile + "?t=" + Date.now();
            }
        }

        async function generateDeviation() {
            const response = await axios.get(`/deviation?time=${time}`);


            document.getElementById('violinDeviationPlot').innerHTML = "";
            document.getElementById('fluteDeviationPlot').innerHTML = "";
            document.getElementById('clarinetDeviationPlot').innerHTML = "";
            document.getElementById('pianoDeviationPlot').innerHTML = "";
            
            for (i = 1; i < instruments.length; i++) {
                const instrument = instruments[i];
                const plotFile = response.data[instrument].file;
                const plotPath = instrument + "DeviationPlot";
                document.getElementById(plotPath).src = plotFile + "?t=" + Date.now();
            }
        }
            /*
             
        */
        </script>
    </body>
</html>